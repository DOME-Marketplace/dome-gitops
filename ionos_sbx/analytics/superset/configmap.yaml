apiVersion: v1
kind: ConfigMap
metadata:
  name: superset-startup
  namespace: analytics
  labels:
    app.kubernetes.io/name: superset-analytics
    app.kubernetes.io/component: config
data:
  startup.sh: |
    #!/bin/bash
    set -e
    
    echo "Updating package lists..."
    apt-get update -qq

    echo "Installing Redis and git..."
    DEBIAN_FRONTEND=noninteractive apt-get install -y redis-server git
    
    echo "Starting Redis server..."
    redis-server --daemonize yes --bind 127.0.0.1 --port 6379 --maxmemory 256mb --maxmemory-policy allkeys-lru
    
    echo "Waiting for Redis to start..."
    sleep 5
    
    # Test Redis connection
    redis-cli ping || (echo "Redis failed to start" && exit 1)
    
    echo "Setting up Superset environment..."
    export SUPERSET_CONFIG_PATH=/app/pythonpath/superset_config.py
    export PYTHONPATH=/app/pythonpath:$PYTHONPATH
    
    # Create config directory
    mkdir -p /app/pythonpath
    
    # Create client_secret.json for OIDC
    cat > /app/pythonpath/client_secret.json << 'EOF'
    {
        "web": {
            "issuer": "https://cs-identity.dome-marketplace-sbx.org/realms/dome",
            "auth_uri": "https://cs-identity.dome-marketplace-sbx.org/realms/dome/protocol/openid-connect/auth",
            "client_id": "analytics-platform",
            "client_secret": "ci8q7ZczfuWjshBKv8ybRC3ADn9a6FUX",
            "userinfo_uri": "https://cs-identity.dome-marketplace-sbx.org/realms/dome/protocol/openid-connect/userinfo",
            "token_uri": "https://cs-identity.dome-marketplace-sbx.org/realms/dome/protocol/openid-connect/token",
            "token_introspection_uri": "https://cs-identity.dome-marketplace-sbx.org/realms/dome/protocol/openid-connect/token/introspect"
        }
    }
    EOF
    
    # Create OIDC security manager
    cat > /app/pythonpath/oidc_security_manager.py << 'EOF'
    import logging
    from flask_appbuilder.views import ModelView, SimpleFormView, expose
    from flask import redirect, request
    from urllib.parse import quote
    from flask_login import login_user
    from flask_appbuilder.security.views import AuthOIDView
    from flask_oidc import OpenIDConnect
    from superset.security import SupersetSecurityManager
    from flask_appbuilder.security.manager import AUTH_OID


    class OIDCSecurityManager(SupersetSecurityManager):

        def __init__(self, appbuilder):
            super(OIDCSecurityManager, self).__init__(appbuilder)
            if self.auth_type == AUTH_OID:
                self.oid = OpenIDConnect(self.appbuilder.get_app)
            self.authoidview = AuthOIDCView


    class AuthOIDCView(AuthOIDView):

        @expose('/login/', methods=['GET', 'POST'])
        def login(self, flag=True):
            sm = self.appbuilder.sm
            oidc = sm.oid

            @self.appbuilder.sm.oid.require_login
            def handle_login():
                user = sm.auth_user_oid(oidc.user_getfield('email'))
                if user is None:
                    if sm.find_role('example_viewer') is None:
                        sm.add_role('example_viewer')
                    info = oidc.user_getinfo(
                        ['preferred_username', 'given_name', 'family_name', 'email'])
                    user = sm.add_user(info.get('preferred_username'), info.get(
                        'given_name'), info.get('family_name'), info.get('email'), [sm.find_role('Gamma'),sm.find_role('example_viewer')])
                login_user(user, remember=True, force=True)
                return redirect(self.appbuilder.get_url_for_index)

            return handle_login()

        @expose('/logout/', methods=['GET', 'POST'])
        def logout(self):
            oidc = self.appbuilder.sm.oid

            oidc.logout()
            super(AuthOIDCView, self).logout()
            redirect_url = request.url_root.strip(
                '/') + self.appbuilder.get_url_for_login

            return redirect(
                oidc.client_secrets.get('issuer') + '/protocol/openid-connect/logout?redirect_uri=' + quote(redirect_url))
    EOF
    
    # Create superset config with OIDC integration
    cat > /app/pythonpath/superset_config.py << 'EOF'
    import os
    from oidc_security_manager import OIDCSecurityManager
    from flask_appbuilder.security.manager import AUTH_OID
    
    # Database - using SQLite with persistent storage
    SQLALCHEMY_DATABASE_URI = 'sqlite:////app/data/superset.db'
    
    # Redis configuration
    REDIS_HOST = '127.0.0.1'
    REDIS_PORT = 6379
    
    # Celery configuration
    CELERY_CONFIG = {
        'broker_url': f'redis://{REDIS_HOST}:{REDIS_PORT}/0',
        'result_backend': f'redis://{REDIS_HOST}:{REDIS_PORT}/0',
        'worker_log_level': 'INFO',
        'worker_prefetch_multiplier': 1,
        'task_acks_late': True,
    }
    
    # Cache configuration
    CACHE_CONFIG = {
        'CACHE_TYPE': 'RedisCache',
        'CACHE_REDIS_HOST': REDIS_HOST,
        'CACHE_REDIS_PORT': REDIS_PORT,
        'CACHE_REDIS_DB': 1,
        'CACHE_DEFAULT_TIMEOUT': 300,
    }
    
    # Security - Keycloak/OIDC Configuration
    SECRET_KEY = 'ci8q7ZczfuWjshBKv8ybRC3ADn9a6FUX'
    WTF_CSRF_ENABLED = False
    
    # Enable proxy fix for running behind ingress/load balancer
    ENABLE_PROXY_FIX = True
    PROXY_FIX_CONFIG = {"x_for": 1, "x_proto": 1, "x_host": 1, "x_port": 0, "x_prefix": 1}
    
    # Authentication type
    AUTH_TYPE = AUTH_OID
    
    # OIDC Configuration
    OIDC_CLIENT_SECRETS = '/app/pythonpath/client_secret.json'
    OIDC_ID_TOKEN_COOKIE_SECURE = True  # Set to True for HTTPS
    OIDC_OPENID_REALM = 'dome'
    OIDC_INTROSPECTION_AUTH_METHOD = 'client_secret_post'
    OIDC_COOKIE_SECURE = True  # Ensure cookies are only sent over HTTPS
    OIDC_REDIRECT_HOST = 'analytics.dome-marketplace-sbx.org'
    
    # Custom security manager
    CUSTOM_SECURITY_MANAGER = OIDCSecurityManager
    
    # User registration settings
    AUTH_USER_REGISTRATION = True
    AUTH_USER_REGISTRATION_ROLE = 'Gamma'
    
    # Anonymous user role
    AUTH_ROLE_PUBLIC = "Public"
    
    # Role assignment logic
    AUTH_USER_REGISTRATION_ROLE_JMESPATH = "'Testme' && 'Gamma' || 'Gamma'"
    
    # Sync roles at each login
    AUTH_ROLES_SYNC_AT_LOGIN = True
    
    # Feature flags
    FEATURE_FLAGS = {
        'ENABLE_TEMPLATE_PROCESSING': True,
    }
    
    # Load examples
    SUPERSET_LOAD_EXAMPLES = True
    
    # Webserver config
    SUPERSET_WEBSERVER_PORT = 8088
    SUPERSET_WEBSERVER_ADDRESS = '0.0.0.0'
    
    WEBDRIVER_BASEURL = 'https://analytics.dome-marketplace-sbx.org/'
    
    # Session configuration for OIDC state persistence
    SESSION_COOKIE_SECURE = True
    SESSION_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SAMESITE = 'Lax'

    from flask_caching import Cache
    RESULTS_BACKEND = Cache(config={
        'CACHE_TYPE': 'RedisCache',
        'CACHE_REDIS_HOST': REDIS_HOST,
        'CACHE_REDIS_PORT': REDIS_PORT,
        'CACHE_REDIS_DB': 2,
    })

    # Flask session type - use Redis
    SESSION_TYPE = 'redis'
    import redis
    SESSION_REDIS = redis.Redis(host=REDIS_HOST, port=REDIS_PORT, db=3)
    
    # SIP 15 support
    SIP_15_ENABLED = True
    EOF
    
    # Ensure data directory exists
    mkdir -p /app/data
    
    echo "Installing required OIDC and database packages..."
    # Install OIDC packages - using fedora-infra fork which is actively maintained
    pip install --no-cache-dir \
        Authlib \
        flask-openid \
        git+https://github.com/fedora-infra/flask-oidc.git@2.2.0 \
        || echo "OIDC package installation completed with warnings"
    
    # Install database drivers - using compatible versions
    pip install --no-cache-dir \
        'crate[sqlalchemy]>=0.35.0' \
        sqlalchemy_trino==0.4.1 \
        sqlalchemy-drill==1.1.2 \
        mysqlclient==2.1.0 \
        pymssql==2.2.5 \
        || echo "Database driver installation completed with warnings"
    
    echo "Initializing Superset database..."
    superset db upgrade
    
    echo "Creating admin user..."
    superset fab create-admin \
        --username admin \
        --firstname Admin \
        --lastname User \
        --email admin@example.com \
        --password admin 2>/dev/null || echo "Admin user may already exist"
    
    echo "Loading examples..."
    superset load_examples 2>/dev/null || echo "Examples may already be loaded"
    
    echo "Initializing Superset..."
    superset init
    
    echo "Starting Celery worker in background..."
    nohup celery --app=superset.tasks.celery_app:app worker --loglevel=info > /tmp/celery.log 2>&1 &
    
    echo "Waiting for Celery to start..."
    sleep 10
    
    echo "Starting Superset web server..."
    exec superset run -h 0.0.0.0 -p 8088 --with-threads

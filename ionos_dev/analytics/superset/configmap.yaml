apiVersion: v1
kind: ConfigMap
metadata:
  name: superset-startup
  namespace: analytics
  labels:
    app.kubernetes.io/name: superset-analytics
    app.kubernetes.io/component: config
data:
  startup.sh: |
    #!/bin/bash
    set -e
    
    echo "Updating package lists..."
    apt-get update -qq
    
    echo "Installing Redis..."
    DEBIAN_FRONTEND=noninteractive apt-get install -y redis-server
    
    echo "Starting Redis server..."
    redis-server --daemonize yes --bind 127.0.0.1 --port 6379 --maxmemory 256mb --maxmemory-policy allkeys-lru
    
    echo "Waiting for Redis to start..."
    sleep 5
    
    # Test Redis connection
    redis-cli ping || (echo "Redis failed to start" && exit 1)
    
    echo "Setting up Superset environment..."
    export SUPERSET_CONFIG_PATH=/app/pythonpath/superset_config.py
    export PYTHONPATH=/app/pythonpath:$PYTHONPATH
    
    # Create config directory
    mkdir -p /app/pythonpath
    
    # Create superset config
    cat > /app/pythonpath/superset_config.py << 'EOF'
    import os
    
    # Database - using SQLite with persistent storage
    SQLALCHEMY_DATABASE_URI = 'sqlite:////app/data/superset.db'
    
    # Redis configuration
    REDIS_HOST = '127.0.0.1'
    REDIS_PORT = 6379
    
    # Celery configuration
    CELERY_CONFIG = {
        'broker_url': f'redis://{REDIS_HOST}:{REDIS_PORT}/0',
        'result_backend': f'redis://{REDIS_HOST}:{REDIS_PORT}/0',
        'worker_log_level': 'INFO',
        'worker_prefetch_multiplier': 1,
        'task_acks_late': True,
    }
    
    # Cache configuration
    CACHE_CONFIG = {
        'CACHE_TYPE': 'RedisCache',
        'CACHE_REDIS_HOST': REDIS_HOST,
        'CACHE_REDIS_PORT': REDIS_PORT,
        'CACHE_REDIS_DB': 1,
        'CACHE_DEFAULT_TIMEOUT': 300,
    }
    
    # Security
    SECRET_KEY = 'your-secret-key-change-in-production'
    WTF_CSRF_ENABLED = False
    
    # Feature flags
    FEATURE_FLAGS = {
        'ENABLE_TEMPLATE_PROCESSING': True,
        'PRESTO_EXPAND_DATA': True,
        'ALERT_REPORTS': True,
        'DASHBOARD_RBAC': True,
    }
    
    # =========================================================
    # CSP - Allow Google Fonts
    # =========================================================
    TALISMAN_ENABLED = True
    TALISMAN_CONFIG = {
        "content_security_policy": {
            "font-src": ["'self'", "https://fonts.googleapis.com", "https://fonts.gstatic.com"],
            "style-src": ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
        }
    }

    # =========================================================
    # Theme - Load Blinker font via fontUrls
    # =========================================================
    THEME_DEFAULT = {
        "token": {
            "fontUrls": [
                "https://fonts.googleapis.com/css2?family=Blinker:wght@300;400;600;700&display=swap",
            ],
            "fontFamily": "'Blinker', system-ui, sans-serif",
        }
    }

    # =========================================================
    # Custom CSS - DOME branding variables and font override
    # =========================================================
    CUSTOM_CSS = """
    :root {
        --dome-primary: #3F83F8;
        --dome-primary-dark: #1C64F2;
        --dome-secondary: #0C1C38;
        --dome-bg-light: #F9FAFB;
        --dome-bg-white: #FFFFFF;
        --dome-text-dark: #111827;
        --dome-text-gray: #6B7280;
        --dome-border: #E5E7EB;
        --dome-hover: #F3F4F6;
    }

    body, html, * {
        font-family: 'Blinker', system-ui, sans-serif !important;
    }

    body {
      background-color: var(--dome-bg-light) !important;
    }

    /* Header styling - make it look like DOME */
    header.top {
      background-color: var(--dome-bg-white) !important;
      border-bottom: 1px solid var(--dome-border) !important;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1) !important;
    }

    /* Navigation menu items */
    .ant-menu-horizontal {
      background-color: transparent !important;
      border-bottom: none !important;
    }

    .ant-menu-item,
    .ant-menu-submenu {
      color: var(--dome-text-dark) !important;
      font-weight: 400 !important;
    }

    .ant-menu-item:hover,
    .ant-menu-submenu:hover {
      color: var(--dome-primary) !important;
      background-color: var(--dome-hover) !important;
    }

    .ant-menu-item a,
    .ant-menu-submenu a {
      color: var(--dome-text-dark) !important;
    }

    .ant-menu-item a:hover,
    .ant-menu-submenu a:hover {
      color: var(--dome-primary) !important;
    }

    /* Active menu items */
    .ant-menu-item-selected,
    .ant-menu-item-active {
      color: var(--dome-primary) !important;
      border-bottom-color: var(--dome-primary) !important;
    }

    /* Buttons - DOME style */
    button.ant-btn,
    .superset-button {
      font-family: 'Blinker', sans-serif !important;
      font-weight: 600 !important;
      border-radius: 0.5rem !important;
      transition: all 0.2s ease !important;
    }

    .superset-button-tertiary {
      background-color: var(--dome-primary) !important;
      color: white !important;
      border: none !important;
    }

    .superset-button-tertiary:hover {
      background-color: var(--dome-primary-dark) !important;
    }

    .superset-button-link {
      color: var(--dome-primary) !important;
    }

    .superset-button-link:hover {
      color: var(--dome-primary-dark) !important;
      text-decoration: underline !important;
    }

    /* Cards - DOME style */
    .ant-card {
      background-color: var(--dome-bg-white) !important;
      border: 1px solid var(--dome-border) !important;
      border-radius: 0.75rem !important;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1) !important;
      transition: all 0.3s ease !important;
    }

    .ant-card:hover {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
      transform: translateY(-2px) !important;
    }

    /* Card titles */
    .ant-card-meta-title {
      color: var(--dome-text-dark) !important;
      font-weight: 600 !important;
    }

    .ant-card-meta-description {
      color: var(--dome-text-gray) !important;
    }

    /* Tags - DOME style */
    .ant-tag {
      background-color: #DBEAFE !important;
      color: var(--dome-primary) !important;
      border: 1px solid #BFDBFE !important;
      border-radius: 0.375rem !important;
      font-weight: 500 !important;
    }

    /* Collapse sections */
    .ant-collapse {
      background-color: transparent !important;
      border: none !important;
    }

    .ant-collapse-header {
      color: var(--dome-text-dark) !important;
      font-weight: 600 !important;
      font-size: 1.125rem !important;
    }

    /* Content areas */
    .css-nfjnv9,
    .css-vhf0sc {
      background-color: var(--dome-bg-light) !important;
    }

    /* Icons - adjust colors */
    .anticon svg {
      color: var(--dome-text-gray) !important;
    }

    .anticon:hover svg {
      color: var(--dome-primary) !important;
    }

    /* Links */
    a {
      color: var(--dome-primary) !important;
      text-decoration: none !important;
    }

    a:hover {
      color: var(--dome-primary-dark) !important;
      text-decoration: underline !important;
    }

    /* Tab navigation */
    .no-router {
      color: var(--dome-text-gray) !important;
      font-weight: 500 !important;
    }

    .no-router.active {
      color: var(--dome-primary) !important;
      border-bottom: 2px solid var(--dome-primary) !important;
    }

    /* Favorite icons */
    .fave-unfave-icon svg path {
      fill: var(--dome-text-gray) !important;
    }

    .fave-unfave-icon:hover svg path {
      fill: #FCD34D !important;
    }

    /* Dropdown menus */
    .ant-dropdown-trigger:hover {
      color: var(--dome-primary) !important;
    }

    /* Main content wrapper */
    #app {
      background-color: var(--dome-bg-light) !important;
    }

    /* Navbar brand/logo area */
    .navbar-brand {
      padding: 0.5rem 1rem !important;
    }

    /* Menu header */
    .menu .header {
      color: var(--dome-text-dark) !important;
      font-weight: 700 !important;
      font-size: 1.25rem !important;
    }

    /* Card grid layout */
    .css-10rqylw {
      gap: 1.5rem !important;
    }

    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }

    /* Focus states for accessibility */
    *:focus {
      outline: 2px solid var(--dome-primary) !important;
      outline-offset: 2px !important;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--dome-bg-light);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--dome-text-gray);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--dome-primary);
    }
    """

    # Load examples
    SUPERSET_LOAD_EXAMPLES = False
    
    # Webserver config
    SUPERSET_WEBSERVER_PORT = 8088
    SUPERSET_WEBSERVER_ADDRESS = '0.0.0.0'
    EOF
    
    # Ensure data directory exists
    mkdir -p /app/data
    
    echo "Initializing Superset database..."
    superset db upgrade
    
    echo "Creating admin user..."
    superset fab create-admin \
        --username admin \
        --firstname Admin \
        --lastname User \
        --email admin@example.com \
        --password admin 2>/dev/null || echo "Admin user may already exist"
    
    echo "Loading examples..."
    superset load_examples 2>/dev/null || echo "Examples may already be loaded"
    
    echo "Initializing Superset..."
    superset init
    
    echo "Starting Celery worker in background..."
    nohup celery --app=superset.tasks.celery_app:app worker --loglevel=info > /tmp/celery.log 2>&1 &
    
    echo "Waiting for Celery to start..."
    sleep 10
    
    echo "Starting Superset web server..."
    exec superset run -h 0.0.0.0 -p 8088 --with-threads
